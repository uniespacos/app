name: Deploy to Staging

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: read
  packages: write

jobs:
  lint:
    name: ðŸ” Lint & Static Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Dependencies
        run: |
          composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist
          npm ci --no-optional

      - name: Run Pint (PHP Code Style)
        run: vendor/bin/pint --test

      - name: Run ESLint (Frontend Linting)
        run: npm run lint

  test:
    name: ðŸ§ª Run Tests
    needs: lint
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Expose UID and GID
        run: |
          echo "UID=$(id -u)" >> $GITHUB_ENV
          echo "GID=$(id -g)" >> $GITHUB_ENV

      - name: Build Services
        run: UID=${{ env.UID }} GID=${{ env.GID }} docker compose -f docker-compose.test.yml build

      - name: Start Services
        run: UID=${{ env.UID }} GID=${{ env.GID }} docker compose -f docker-compose.test.yml up -d

      - name: Wait for database to be ready
        run: |
          echo "Waiting for postgres..."
          until docker compose -f docker-compose.test.yml exec postgres pg_isready -U uniespacos -d uniespacos; do
            sleep 2
          done
          echo "Postgres is ready!"

      - name: Wait for workspace to be ready
        run: |
          timeout_seconds=300
          elapsed_seconds=0
          echo "Waiting for workspace service to become healthy..."
          while [ "$elapsed_seconds" -lt "$timeout_seconds" ]; do
            container_id=$(docker compose -f docker-compose.test.yml ps -q workspace)
            if [ -z "$container_id" ]; then
              echo "Workspace container not found. Waiting..."
              sleep 5
              elapsed_seconds=$((elapsed_seconds + 5))
              continue
            fi

            workspace_status=$(docker inspect --format='{{.State.Health.Status}}' "$container_id" 2>/dev/null)
            if [ "$workspace_status" == "healthy" ]; then
              echo "Workspace service is healthy!"
              break
            fi
            echo "Waiting for workspace service (current status: ${workspace_status})... ${elapsed_seconds}s/${timeout_seconds}s"
            sleep 5
            elapsed_seconds=$((elapsed_seconds + 5))
          done

          if [ "$workspace_status" != "healthy" ]; then
            echo "Error: Workspace service did not become healthy within ${timeout_seconds} seconds."
            exit 1
          fi

      - name: Setup Environment
        run: |
          docker compose -f docker-compose.test.yml exec -T workspace /bin/bash -c "
            export NVM_DIR="\$HOME/.nvm"
            [ -s "\$NVM_DIR/nvm.sh" ] && \. "\$NVM_DIR/nvm.sh"

            set -e
            echo 'Copying .env file...'
            cp .env.testing .env

            echo 'Installing PHP dependencies...'
            composer install --no-interaction --no-progress --prefer-dist

            echo 'Generating app key...'
            php artisan key:generate

            echo 'Creating dummy Vite manifest...'
            mkdir -p public/build/assets
            touch public/build/assets/app.js
            echo '{"resources/js/app.tsx": {"file": "assets/app.js", "src": "resources/js/app.tsx", "isEntry": true}}' > public/build/manifest.json
          "

      - name: Run Migrations
        run: |
          docker compose -f docker-compose.test.yml exec -T workspace php artisan migrate --seed --force

      - name: Install Node Dependencies
        run: |
          docker compose -f docker-compose.test.yml exec -T workspace /bin/bash -c "
            . /home/www/.nvm/nvm.sh &&
            npm config set fetch-timeout 600000 &&
            npm ci --verbose
          "

      - name: Run Frontend Tests
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
        run: |
          docker compose -f docker-compose.test.yml exec -T workspace /bin/bash -c "
           . /home/www/.nvm/nvm.sh &&
           npm test
          "

      - name: Run Backend Tests
        env:
          APP_ENV: testing
        run: |
          docker compose -f docker-compose.test.yml exec -T workspace php artisan test | tee phpunit_output.txt
          grep -q "Tests:    [0-9]\+ passed" phpunit_output.txt

      - name: Stop Services
        if: always()
        run: docker compose -f docker-compose.test.yml down

  deploy_staging:
    name: ðŸš€ Build, Push & Deploy to Staging
    needs: test
    runs-on: ubuntu-latest
    environment:
      name: staging
    env:
      CF_ID: ${{ secrets.CF_ACCESS_CLIENT_ID_STAGING }}
      CF_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET_STAGING }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository }}/app
            ghcr.io/${{ github.repository }}/web
          tags: |
            type=semver,pattern={{version}}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install & Build Frontend
        env:
          VITE_REVERB_APP_KEY: ${{ secrets.VITE_REVERB_APP_KEY }}
        run: npm ci && npm run build

      - name: Build and push PHP App Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/production/php-fpm/Dockerfile
          target: production
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VITE_REVERB_APP_KEY=${{ secrets.VITE_REVERB_APP_KEY }}
            VITE_REVERB_HOST=${{ secrets.VITE_REVERB_HOST }}
            VITE_REVERB_PORT=${{ secrets.VITE_REVERB_PORT }}
            VITE_REVERB_SCHEME=${{ secrets.VITE_REVERB_SCHEME }}

      - name: Build and push Nginx Web Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/production/nginx/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Install cloudflared
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY_STAGING }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "Host ${{ secrets.SSH_HOST_STAGING }}
            User ${{ secrets.SSH_USER_STAGING }}
            IdentityFile ~/.ssh/id_ed25519
            ProxyCommand cloudflared access ssh --hostname %h
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null" > ~/.ssh/config
          chmod 600 ~/.ssh/config

      - name: Deploy to Staging via SSH
        run: |
          STAGING_PATH="${{secrets.PATH_TO_APP_FOLDER_STAGING}}"
          IMAGE_TAG=$(echo ${{ github.ref_name }} | sed 's/^v//')

          # Securely copy the new deployment script to the server
          scp ./compose.staging.yml ${{ secrets.SSH_USER_STAGING }}@${{ secrets.SSH_HOST_STAGING }}:${STAGING_PATH}/compose.staging.yml
          scp ./scripts/deploy.sh ${{ secrets.SSH_USER_STAGING }}@${{ secrets.SSH_HOST_STAGING }}:${STAGING_PATH}/deploy.sh

          # Execute the script on the remote server
          ssh ${{ secrets.SSH_USER_STAGING }}@${{ secrets.SSH_HOST_STAGING }} "
            set -e
            cd ${STAGING_PATH}
            chmod +x deploy.sh
            
            # Log into GHCR on the remote server to pull images
            echo '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u '${{ github.actor }}' --password-stdin

            # Run the deployment script, passing the semver tag
            set -a
            source .env
            set +a
            ./deploy.sh ${IMAGE_TAG}
          "
