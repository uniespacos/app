name: CI/CD

on:
  push:
    branches:
      - "main"
      - "development"
  pull_request:
    branches:
      - development
      - main
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  lint:
    name: ğŸ” Lint & Static Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'

      - name: Install Dependencies
        run: |
          composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist
          npm ci

      - name: Run Pint (PHP Code Style)
        run: vendor/bin/pint --test
        
      - name: Run ESLint (Frontend Linting)
        run: npm run lint

      - name: Fix and Check Formatting (Frontend)
        run: npm run format

  test:
    name: ğŸ§ª Run Tests
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Services
        run: docker compose -f docker-compose.test.yml build

      - name: Start Services
        run: docker compose -f docker-compose.test.yml up -d

      - name: Debug Workspace Container Startup
        run: |
          echo "Current running containers:"
          docker compose -f docker-compose.test.yml ps
          echo "Workspace container logs:"
          docker compose -f docker-compose.test.yml logs workspace

      - name: Wait for database to be ready
        run: |
          echo "Waiting for postgres..."
          until docker compose -f docker-compose.test.yml exec postgres pg_isready -U uniespacos -d uniespacos; do
            sleep 2
          done
          echo "Postgres is ready!"

      - name: Wait for workspace to be ready
        run: |
          timeout_seconds=300
          elapsed_seconds=0
          echo "Waiting for workspace service to become healthy..."
          while [ "$elapsed_seconds" -lt "$timeout_seconds" ]; do
            container_id=$(docker compose -f docker-compose.test.yml ps -q workspace)
            if [ -z "$container_id" ]; then
              echo "Workspace container not found. Waiting..."
              sleep 5
              elapsed_seconds=$((elapsed_seconds + 5))
              continue
            fi
          
            workspace_status=$(docker inspect --format='{{.State.Health.Status}}' "$container_id" 2>/dev/null)
            if [ "$workspace_status" == "healthy" ]; then
              echo "Workspace service is healthy!"
              break
            fi
            echo "Waiting for workspace service (current status: ${workspace_status})... ${elapsed_seconds}s/${timeout_seconds}s"
            sleep 5
            elapsed_seconds=$((elapsed_seconds + 5))
          done

          if [ "$workspace_status" != "healthy" ]; then
            echo "Error: Workspace service did not become healthy within ${timeout_seconds} seconds."
            exit 1
          fi

      - name: Fix Permissions
        run: docker compose -f docker-compose.test.yml exec -T --user=root workspace chown -R 1000:1000 /var/www/storage /var/www/bootstrap/cache

      - name: Install PHP Dependencies
        run: docker compose -f docker-compose.test.yml exec -T --user=1000 workspace composer install --no-interaction --no-progress --prefer-dist

      - name: Create dummy Vite manifest
        run: |
          mkdir -p public/build
          echo '{}' > public/build/manifest.json

      - name: Run Migrations and Seed
        run: docker compose -f docker-compose.test.yml exec -T workspace php artisan migrate --seed --force

      - name: Run Backend Tests (PHPUnit)
        run: docker compose -f docker-compose.test.yml exec -T workspace php artisan test
      
      # Add this step once frontend tests are configured
      # - name: Run Frontend Tests
      #   run: npm test

      - name: Stop Services
        if: always()
        run: docker compose -f docker-compose.test.yml down

  build-and-push:
    name: ğŸ³ Build & Push to GHCR
    if: github.event_name == 'push'
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Docker meta for app image
        id: meta_app
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/app
          tags: |
            type=ref,event=branch
            type=sha,prefix=sha-
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Generate Docker meta for web image
        id: meta_web
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/web
          tags: |
            type=ref,event=branch
            type=sha,prefix=sha-
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install & Build Frontend
        run: npm ci && npm run build

      - name: Build and push PHP App Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/production/php-fpm/Dockerfile
          target: production
          push: true
          tags: ${{ steps.meta_app.outputs.tags }}
          labels: ${{ steps.meta_app.outputs.labels }}

      - name: Build and push Nginx Web Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/production/nginx/Dockerfile
          push: true
          tags: ${{ steps.meta_web.outputs.tags }}
          labels: ${{ steps.meta_web.outputs.labels }}

  deploy:
    name: ğŸš€ Deploy to Production
    if: github.ref == 'refs/heads/main'
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script_stop: true
          script: |
            echo "ğŸ“ Starting Deploy..."
            cd /var/www/uniespacos # ADJUST THIS PATH IF NEEDED

            echo "ğŸ”’ Maintenance Mode ON"
            docker compose -f compose.prod.yml exec -T web php artisan down || true

            echo "ğŸ“¥ Pulling latest code"
            git pull origin main
            
            echo "DOCKER_USER=${{ github.actor }}" > .env.gh
            echo "DOCKER_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> .env.gh

            echo "ğŸ” Logging into GHCR"
            cat .env.gh | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            echo "ğŸ³ Pulling latest images"
            docker compose -f compose.prod.yml pull

            echo "ğŸš€ Launching new containers"
            docker compose -f compose.prod.yml up -d --remove-orphans

            echo "â³ Waiting for services..."
            sleep 15

            echo "ğŸ”„ Running Migrations"
            docker compose -f compose.prod.yml exec -T web php artisan migrate --force

            echo "ğŸ§¹ Optimizing Application"
            docker compose -f compose.prod.yml exec -T web php artisan optimize:clear
            docker compose -f compose.prod.yml exec -T web php artisan optimize
            docker compose -f compose.prod.yml exec -T web php artisan view:cache
            docker compose -f compose.prod.yml exec -T web php artisan config:cache

            echo "ğŸ”„ Restarting Queue Worker"
            docker compose -f compose.prod.yml restart queue-worker

            echo "âœ… Maintenance Mode OFF"
            docker compose -f compose.prod.yml exec -T web php artisan up

            echo "ğŸ‰ Deploy finished successfully!"
